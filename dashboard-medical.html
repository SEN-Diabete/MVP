<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard M√©dical - SEN'Diab√®te</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        :root { --primary: #2E8B57; }
        body { background: #f8f9fa; }
        .navbar { background: var(--primary); }
        .kpi-card { background: white; border-radius: 10px; padding: 20px; margin: 10px; text-align: center; box-shadow: 0 3px 10px rgba(0,0,0,0.1); }
        .kpi-number { font-size: 2em; font-weight: bold; color: var(--primary); }
        .nav-tabs .nav-link.active { border-bottom: 3px solid var(--primary); font-weight: bold; }
    </style>
</head>
<body>
    <nav class="navbar navbar-dark">
        <div class="container">
            <span class="navbar-brand">üè• Dashboard M√©dical SEN'Diab√®te</span>
            <button class="btn btn-light btn-sm" onclick="logout()">D√©connexion</button>
        </div>
    </nav>

    <div class="container mt-4">
        <!-- KPI M√©decin -->
        <div class="row">
            <div class="col-md-3">
                <div class="kpi-card">
                    <div class="kpi-number">42</div>
                    <div>Patients Diab√©tiques</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="kpi-card">
                    <div class="kpi-number">5</div>
                    <div>Cas Critiques</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="kpi-card">
                    <div class="kpi-number">8</div>
                    <div>RDV Aujourd'hui</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="kpi-card">
                    <div class="kpi-number">15</div>
                    <div>Glyc√©mies Re√ßues</div>
                </div>
            </div>
        </div>

        <!-- Onglets -->
        <ul class="nav nav-tabs mt-4" id="ongletsMedecin">
            <li class="nav-item">
                <button class="nav-link active" data-bs-target="#patients" data-bs-toggle="tab">üë• Patients</button>
            </li>
            <li class="nav-item">
                <button class="nav-link" data-bs-target="#ordonnances" data-bs-toggle="tab">üíä Ordonnances</button>
            </li>
            <li class="nav-item">
                <button class="nav-link" data-bs-target="#rdv" data-bs-toggle="tab">üìÖ Rendez-vous</button>
            </li>
            <li class="nav-item">
                <button class="nav-link" data-bs-target="#reception" data-bs-toggle="tab">üì® R√©ception</button>
            </li>
        </ul>

        <div class="tab-content mt-3">
            <!-- Onglet Patients -->
            <div class="tab-pane fade show active" id="patients">
                <div class="card">
                    <div class="card-body">
                        <h5>Gestion de la Patient√®le</h5>
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Patient</th>
                                    <th>√Çge</th>
                                    <th>Derni√®re glyc√©mie</th>
                                    <th>Statut</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>Dr. Mamadou Diop</td>
                                    <td>58 ans</td>
                                    <td>1.2 g/L (15/05)</td>
                                    <td><span class="badge bg-success">Contr√¥l√©</span></td>
                                    <td>
                                        <button class="btn btn-sm btn-primary">Dossier</button>
                                        <button class="btn btn-sm btn-success">Ordonnance</button>
                                    </td>
                                </tr>
                                <tr>
                                    <td>Mariama B√¢</td>
                                    <td>62 ans</td>
                                    <td>2.4 g/L (14/05)</td>
                                    <td><span class="badge bg-warning">Surveillance</span></td>
                                    <td>
                                        <button class="btn btn-sm btn-primary">Dossier</button>
                                        <button class="btn btn-sm btn-success">Ordonnance</button>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Onglet Ordonnances -->
            <div class="tab-pane fade" id="ordonnances">
                <div class="card">
                    <div class="card-body">
                        <h5>G√©n√©ration d'Ordonnance</h5>
                        <form>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">Patient</label>
                                        <select class="form-select">
                                            <option>Dr. Mamadou Diop</option>
                                            <option>Mariama B√¢</option>
                                        </select>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Traitement</label>
                                        <textarea class="form-control" rows="5" placeholder="M√©dicaments, posologie..."></textarea>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">Instructions</label>
                                        <textarea class="form-control" rows="3" placeholder="Recommandations..."></textarea>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Prochain contr√¥le</label>
                                        <input type="date" class="form-control">
                                    </div>
                                    <button type="button" class="btn btn-primary">üìÑ G√©n√©rer PDF</button>
                                    <button type="button" class="btn btn-success">üì± Envoyer</button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Onglet R√©ception -->
            <div class="tab-pane fade" id="reception">
                <div class="card">
                    <div class="card-body">
                        <h5>Glyc√©mies Re√ßues des Patients</h5>
                        <div class="alert alert-info">
                            <strong>Nouveau r√©sultat:</strong> Ibrahima Fall - 2.1 g/L<br>
                            <small>Envoy√© le 15/05 √† 10:23 - Commentaire: "Vertiges ce matin"</small>
                            <div class="mt-2">
                                <button class="btn btn-sm btn-primary">üëÅÔ∏è Voir d√©tails</button>
                                <button class="btn btn-sm btn-success">üìÖ Programmer RDV</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
<script>
const API_URL = 'https://script.google.com/macros/s/AKfycbwktHf6luBoFjg35oAMyzFD3DrIXy7pObmkiP5k3nG3xffw3jIJPUJVF3Ef3_BAbt2Z/exec';

// V√âRIFICATION DE CONNEXION
document.addEventListener('DOMContentLoaded', function() {
  const user = JSON.parse(localStorage.getItem('user'));
  
  if (!user || !user.id) {
    window.location.href = 'index.html';
    return;
  }
  
  console.log('M√©decin connect√©:', user);
  
  // CHARGER TOUTES LES DONN√âES DYNAMIQUES
  chargerDonneesMedicales();
});

// CHARGEMENT DYNAMIQUE DES DONN√âES M√âDICALES
async function chargerDonneesMedicales() {
  try {
    await chargerKPIMedecin();
    await chargerPatientsMedecin();
    await chargerGlycemiesRecuesMedecin();
    
  } catch (error) {
    console.error('Erreur chargement donn√©es m√©dicales:', error);
  }
}

// CHARGER LES KPI M√âDECIN DYNAMIQUES
async function chargerKPIMedecin() {
  try {
    const response = await fetch(API_URL + '?action=get_dashboard_medecin');
    const result = await response.json();
    
    if (result.status === 'success') {
      document.getElementById('kpiPatients').textContent = result.data.patients;
      document.getElementById('kpiCritiques').textContent = result.data.critiques;
      document.getElementById('kpiRDV').textContent = result.data.rdvAujourdhui;
      document.getElementById('kpiGlycemiesRecues').textContent = result.data.glycemiesRecues;
    }
  } catch (error) {
    console.error('Erreur KPI m√©decin:', error);
    // Valeurs par d√©faut
    document.getElementById('kpiPatients').textContent = '0';
    document.getElementById('kpiCritiques').textContent = '0';
  }
}

// CHARGER LES PATIENTS DU M√âDECIN
async function chargerPatientsMedecin() {
  try {
    const response = await fetch(API_URL + '?action=get_patients');
    const result = await response.json();
    
    if (result.status === 'success') {
      mettreAJourTableauPatients(result.data);
    }
  } catch (error) {
    console.error('Erreur patients m√©decin:', error);
  }
}

// METTRE √Ä JOUR LE TABLEAU DES PATIENTS
function mettreAJourTableauPatients(patients) {
  const tbody = document.querySelector('#patients table tbody');
  
  if (!tbody) {
    console.error('Tableau patients non trouv√©');
    return;
  }
  
  if (patients.length === 0) {
    tbody.innerHTML = `
      <tr>
        <td colspan="5" class="text-center text-muted">
          Aucun patient dans votre suivi
        </td>
      </tr>
    `;
  } else {
    tbody.innerHTML = patients.map(patient => `
      <tr>
        <td>
          <strong>${patient.nom}</strong>
          ${patient.telephone ? `<br><small class="text-muted">üìû ${patient.telephone}</small>` : ''}
        </td>
        <td>${patient.age || 'N/A'} ans</td>
        <td>
          <span class="badge bg-success">√Ä mesurer</span><br>
          <small class="text-muted">--/--/----</small>
        </td>
        <td>
          <span class="badge bg-secondary">Nouveau</span>
        </td>
        <td>
          <button class="btn btn-sm btn-outline-primary" onclick="ouvrirDossier('${patient.id}')">
            üìÅ Dossier
          </button>
          <button class="btn btn-sm btn-outline-success" onclick="genererOrdonnance('${patient.id}', '${patient.nom}')">
            üíä Ordonnance
          </button>
        </td>
      </tr>
    `).join('');
  }
}

// CHARGER LES GLYC√âMIES RE√áUES PAR LE M√âDECIN
async function chargerGlycemiesRecuesMedecin() {
  try {
    const response = await fetch(API_URL + '?action=get_glycemies');
    const result = await response.json();
    
    if (result.status === 'success') {
      mettreAJourGlycemiesMedecin(result.data);
    }
  } catch (error) {
    console.error('Erreur glyc√©mies m√©decin:', error);
  }
}

// METTRE √Ä JOUR L'AFFICHAGE DES GLYC√âMIES M√âDECIN
function mettreAJourGlycemiesMedecin(glycemies) {
  const containerReception = document.querySelector('#reception .card-body');
  
  if (!containerReception) {
    console.error('Container r√©ception non trouv√©');
    return;
  }
  
  if (glycemies.length === 0) {
    containerReception.innerHTML = '<div class="alert alert-info">Aucune glyc√©mie re√ßue</div>';
  } else {
    containerReception.innerHTML = glycemies.map(glycemie => {
      const date = new Date(glycemie.date).toLocaleDateString('fr-FR');
      const isUrgent = glycemie.glycemie < 0.7 || glycemie.glycemie > 2.5;
      
      return `
        <div class="alert alert-${isUrgent ? 'danger' : 'info'} mb-3">
          <div class="d-flex justify-content-between align-items-start">
            <div>
              <strong>${glycemie.patient}</strong> - ${glycemie.glycemie} g/L
              <br><small class="text-muted">Re√ßu le ${date}</small>
              ${glycemie.commentaire ? `<br><small>üí¨ ${glycemie.commentaire}</small>` : ''}
            </div>
            <span class="badge bg-${isUrgent ? 'danger' : 'info'}">${isUrgent ? 'URGENT' : 'Nouveau'}</span>
          </div>
          <div class="mt-2">
            <button class="btn btn-sm btn-primary" onclick="consulterGlycemie('${glycemie.patient}', ${glycemie.glycemie})">
              üëÅÔ∏è Consulter
            </button>
            <button class="btn btn-sm btn-success" onclick="programmerRdv('${glycemie.patient}')">
              üìÖ RDV
            </button>
          </div>
        </div>
      `;
    }).join('');
  }
}

// FONCTIONS DES BOUTONS M√âDECIN
function ouvrirDossier(patientId) {
  alert(`Ouvrir le dossier m√©dical de: ${patientId}`);
}

function genererOrdonnance(patientId, patientNom) {
  const selectPatient = document.querySelector('#ordonnances select');
  if (selectPatient) {
    // Cr√©er option si elle n'existe pas
    const existingOption = Array.from(selectPatient.options).find(opt => opt.value === patientId);
    if (!existingOption) {
      const newOption = document.createElement('option');
      newOption.value = patientId;
      newOption.textContent = patientNom;
      selectPatient.appendChild(newOption);
    }
    selectPatient.value = patientId;
    
    // Basculer vers l'onglet ordonnances
    const ongletOrdonnances = document.querySelector('#ongletsMedecin button[data-bs-target="#ordonnances"]');
    if (ongletOrdonnances) {
      ongletOrdonnances.click();
    }
  }
}

function consulterGlycemie(patient, glycemie) {
  alert(`Consultation glyc√©mie:\nPatient: ${patient}\nValeur: ${glycemie} g/L`);
}

function programmerRdv(patient) {
  const date = prompt(`Programmer RDV pour ${patient}\nDate (JJ/MM/AAAA):`);
  const heure = prompt('Heure (HH:MM):');
  
  if (date && heure) {
    alert(`‚úÖ RDV programm√© pour ${patient}\nüìÖ ${date} √† ${heure}`);
  }
}

// GESTION DU FORMULAIRE D'ORDONNANCE
document.addEventListener('DOMContentLoaded', function() {
  const formOrdonnance = document.querySelector('#ordonnances form');
  if (formOrdonnance) {
    formOrdonnance.addEventListener('submit', async function(e) {
      e.preventDefault();
      
      const patientSelect = this.querySelector('select');
      const medicamentsTextarea = this.querySelector('textarea');
      
      if (!patientSelect.value || !medicamentsTextarea.value) {
        alert('Veuillez remplir le patient et les m√©dicaments');
        return;
      }
      
      const donnees = {
        action: 'ordonnance_medecin',
        id_patient: patientSelect.value,
        nom_patient: patientSelect.options[patientSelect.selectedIndex].text,
        medicaments: medicamentsTextarea.value,
        medecin: JSON.parse(localStorage.getItem('user')).nom
      };
      
      try {
        const resultat = await fetch(API_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(donnees)
        });
        
        const reponse = await resultat.json();
        
        if (reponse.status === 'success') {
          alert('‚úÖ Ordonnance enregistr√©e avec succ√®s!');
          this.reset();
        } else {
          alert('‚ùå Erreur: ' + reponse.message);
        }
      } catch (error) {
        alert('‚ùå Erreur de connexion');
      }
    });
  }
});

function logout() {
  localStorage.removeItem('user');
  window.location.href = 'index.html';
}
</script>
    
</body>
</html>
