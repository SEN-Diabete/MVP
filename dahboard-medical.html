<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard M√©dical - SEN'Diab√®te</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        :root { --primary: #2E8B57; }
        body { background: #f8f9fa; }
        .navbar { background: var(--primary); }
        .kpi-card { background: white; border-radius: 10px; padding: 20px; margin: 10px; text-align: center; box-shadow: 0 3px 10px rgba(0,0,0,0.1); }
        .kpi-number { font-size: 2em; font-weight: bold; color: var(--primary); }
        .nav-tabs .nav-link.active { border-bottom: 3px solid var(--primary); font-weight: bold; }
    </style>
</head>
<body>
    <nav class="navbar navbar-dark">
        <div class="container">
            <span class="navbar-brand">üè• Dashboard M√©dical SEN'Diab√®te</span>
            <button class="btn btn-light btn-sm" onclick="logout()">D√©connexion</button>
        </div>
    </nav>

    <div class="container mt-4">
        <!-- KPI M√©decin -->
        <div class="row">
            <div class="col-md-3">
                <div class="kpi-card">
                    <div class="kpi-number">42</div>
                    <div>Patients Diab√©tiques</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="kpi-card">
                    <div class="kpi-number">5</div>
                    <div>Cas Critiques</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="kpi-card">
                    <div class="kpi-number">8</div>
                    <div>RDV Aujourd'hui</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="kpi-card">
                    <div class="kpi-number">15</div>
                    <div>Glyc√©mies Re√ßues</div>
                </div>
            </div>
        </div>

        <!-- Onglets -->
        <ul class="nav nav-tabs mt-4" id="ongletsMedecin">
            <li class="nav-item">
                <button class="nav-link active" data-bs-target="#patients" data-bs-toggle="tab">üë• Patients</button>
            </li>
            <li class="nav-item">
                <button class="nav-link" data-bs-target="#ordonnances" data-bs-toggle="tab">üíä Ordonnances</button>
            </li>
            <li class="nav-item">
                <button class="nav-link" data-bs-target="#rdv" data-bs-toggle="tab">üìÖ Rendez-vous</button>
            </li>
            <li class="nav-item">
                <button class="nav-link" data-bs-target="#reception" data-bs-toggle="tab">üì® R√©ception</button>
            </li>
        </ul>

        <div class="tab-content mt-3">
            <!-- Onglet Patients -->
            <div class="tab-pane fade show active" id="patients">
                <div class="card">
                    <div class="card-body">
                        <h5>Gestion de la Patient√®le</h5>
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Patient</th>
                                    <th>√Çge</th>
                                    <th>Derni√®re glyc√©mie</th>
                                    <th>Statut</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>Dr. Mamadou Diop</td>
                                    <td>58 ans</td>
                                    <td>1.2 g/L (15/05)</td>
                                    <td><span class="badge bg-success">Contr√¥l√©</span></td>
                                    <td>
                                        <button class="btn btn-sm btn-primary">Dossier</button>
                                        <button class="btn btn-sm btn-success">Ordonnance</button>
                                    </td>
                                </tr>
                                <tr>
                                    <td>Mariama B√¢</td>
                                    <td>62 ans</td>
                                    <td>2.4 g/L (14/05)</td>
                                    <td><span class="badge bg-warning">Surveillance</span></td>
                                    <td>
                                        <button class="btn btn-sm btn-primary">Dossier</button>
                                        <button class="btn btn-sm btn-success">Ordonnance</button>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Onglet Ordonnances -->
            <div class="tab-pane fade" id="ordonnances">
                <div class="card">
                    <div class="card-body">
                        <h5>G√©n√©ration d'Ordonnance</h5>
                        <form>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">Patient</label>
                                        <select class="form-select">
                                            <option>Dr. Mamadou Diop</option>
                                            <option>Mariama B√¢</option>
                                        </select>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Traitement</label>
                                        <textarea class="form-control" rows="5" placeholder="M√©dicaments, posologie..."></textarea>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">Instructions</label>
                                        <textarea class="form-control" rows="3" placeholder="Recommandations..."></textarea>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Prochain contr√¥le</label>
                                        <input type="date" class="form-control">
                                    </div>
                                    <button type="button" class="btn btn-primary">üìÑ G√©n√©rer PDF</button>
                                    <button type="button" class="btn btn-success">üì± Envoyer</button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Onglet R√©ception -->
            <div class="tab-pane fade" id="reception">
                <div class="card">
                    <div class="card-body">
                        <h5>Glyc√©mies Re√ßues des Patients</h5>
                        <div class="alert alert-info">
                            <strong>Nouveau r√©sultat:</strong> Ibrahima Fall - 2.1 g/L<br>
                            <small>Envoy√© le 15/05 √† 10:23 - Commentaire: "Vertiges ce matin"</small>
                            <div class="mt-2">
                                <button class="btn btn-sm btn-primary">üëÅÔ∏è Voir d√©tails</button>
                                <button class="btn btn-sm btn-success">üìÖ Programmer RDV</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
const API_URL = 'https://script.google.com/macros/s/VOTRE_ID/exec';

// V√âRIFICATION DE CONNEXION
document.addEventListener('DOMContentLoaded', function() {
  const user = JSON.parse(localStorage.getItem('user'));
  
  if (!user || !user.id) {
    window.location.href = 'index.html';
    return;
  }
  
  // Afficher les infos utilisateur
  document.getElementById('userInfo').innerHTML = `
    <small class="text-white">Connect√© en tant que: <strong>${user.nom}</strong> - ${user.structure}</small>
  `;
  
  // CHARGER TOUTES LES DONN√âES DYNAMIQUES
  chargerDonneesMedicales();
});

// CHARGEMENT DYNAMIQUE DES DONN√âES M√âDICALES
async function chargerDonneesMedicales() {
  try {
    await chargerKPIMedecin();
    await chargerPatientsMedecin();
    await chargerGlycemiesRecuesMedecin();
    await chargerOrdonnancesRecentess();
    
  } catch (error) {
    console.error('Erreur chargement donn√©es m√©dicales:', error);
  }
}

// CHARGER LES KPI M√âDECIN DYNAMIQUES
async function chargerKPIMedecin() {
  try {
    // Simulation - √Ä remplacer par appel API r√©el
    const kpiData = {
      patients: 42,
      critiques: 5,
      rdvAujourdhui: 3,
      glycemiesRecues: 8
    };
    
    document.getElementById('kpiPatients').textContent = kpiData.patients;
    document.getElementById('kpiCritiques').textContent = kpiData.critiques;
    document.getElementById('kpiRDV').textContent = kpiData.rdvAujourdhui;
    document.getElementById('kpiGlycemiesRecues').textContent = kpiData.glycemiesRecues;
    
  } catch (error) {
    console.error('Erreur KPI m√©decin:', error);
  }
}

// CHARGER LES PATIENTS DU M√âDECIN
async function chargerPatientsMedecin() {
  try {
    const response = await fetch(API_URL + '?action=get_patients');
    const result = await response.json();
    
    if (result.status === 'success') {
      mettreAJourTableauPatients(result.data);
    }
  } catch (error) {
    console.error('Erreur patients m√©decin:', error);
  }
}

// METTRE √Ä JOUR LE TABLEAU DES PATIENTS
function mettreAJourTableauPatients(patients) {
  const tbody = document.querySelector('#patients table tbody');
  
  if (!tbody) return;
  
  if (patients.length === 0) {
    tbody.innerHTML = `
      <tr>
        <td colspan="6" class="text-center text-muted">
          Aucun patient dans votre suivi
        </td>
      </tr>
    `;
  } else {
    tbody.innerHTML = patients.map(patient => `
      <tr>
        <td>
          <strong>${patient.nom}</strong>
          ${patient.telephone ? `<br><small class="text-muted">üìû ${patient.telephone}</small>` : ''}
        </td>
        <td>${patient.age || 'N/A'} ans</td>
        <td>
          <span class="badge bg-success">1.4 g/L</span><br>
          <small class="text-muted">15/05/2023</small>
        </td>
        <td>
          <span class="badge bg-success">Contr√¥l√©</span>
        </td>
        <td>
          <button class="btn btn-sm btn-outline-primary" onclick="ouvrirDossier('${patient.id}')">
            üìÅ Dossier
          </button>
          <button class="btn btn-sm btn-outline-success" onclick="genererOrdonnance('${patient.id}')">
            üíä Ordonnance
          </button>
        </td>
      </tr>
    `).join('');
  }
}

// CHARGER LES GLYC√âMIES RE√áUES PAR LE M√âDECIN
async function chargerGlycemiesRecuesMedecin() {
  try {
    const response = await fetch(API_URL + '?action=get_glycemies');
    const result = await response.json();
    
    if (result.status === 'success') {
      // Filtrer seulement celles destin√©es au m√©decin
      const glycemiesMedecin = result.data.filter(g => 
        g.destination === 'medecin' || g.destination === 'm√©decin'
      );
      mettreAJourGlycemiesMedecin(glycemiesMedecin);
    }
  } catch (error) {
    console.error('Erreur glyc√©mies m√©decin:', error);
  }
}

// METTRE √Ä JOUR L'AFFICHAGE DES GLYC√âMIES M√âDECIN
function mettreAJourGlycemiesMedecin(glycemies) {
  const containerReception = document.getElementById('reception');
  const containerAlertes = document.getElementById('listeAlertes');
  
  if (!containerReception && !containerAlertes) return;
  
  const glycemiesHTML = glycemies.map(glycemie => {
    const date = new Date(glycemie.date).toLocaleDateString('fr-FR');
    const isUrgent = glycemie.glycemie < 0.7 || glycemie.glycemie > 2.5;
    const badgeClass = isUrgent ? 'danger' : 'info';
    
    return `
      <div class="alert alert-${isUrgent ? 'danger' : 'info'}">
        <div class="d-flex justify-content-between align-items-start">
          <div>
            <strong>${glycemie.patient}</strong> - ${glycemie.glycemie} g/L
            <br><small class="text-muted">Re√ßu le ${date}</small>
            ${glycemie.commentaire ? `<br><small>üí¨ ${glycemie.commentaire}</small>` : ''}
          </div>
          <span class="badge bg-${badgeClass}">${isUrgent ? 'URGENT' : 'Nouveau'}</span>
        </div>
        <div class="mt-2">
          <button class="btn btn-sm btn-primary" onclick="consulterGlycemie('${glycemie.patient}', ${glycemie.glycemie})">
            üëÅÔ∏è Consulter
          </button>
          <button class="btn btn-sm btn-success" onclick="programmerRdv('${glycemie.patient}')">
            üìÖ RDV
          </button>
          ${isUrgent ? `
          <button class="btn btn-sm btn-warning" onclick="contacterUrgence('${glycemie.patient}')">
            üö® Urgence
          </button>
          ` : ''}
        </div>
      </div>
    `;
  }).join('');
  
  if (containerReception) {
    containerReception.innerHTML = glycemiesHTML || '<div class="alert alert-info">Aucune glyc√©mie re√ßue</div>';
  }
  
  if (containerAlertes) {
    const alertesUrgentes = glycemies.filter(g => g.glycemie < 0.7 || g.glycemie > 2.5);
    containerAlertes.innerHTML = alertesUrgentes.map(alerte => `
      <div class="alert alert-warning">
        <strong>‚ö†Ô∏è Alerte:</strong> ${alerte.patient}<br>
        <small>Glyc√©mie: ${alerte.glycemie} g/L - ${new Date(alerte.date).toLocaleDateString()}</small>
      </div>
    `).join('') || '<div class="alert alert-success">Aucune alerte urgente</div>';
  }
}

// CHARGER LES ORDONNANCES R√âCENTES
async function chargerOrdonnancesRecentess() {
  // Simulation - √Ä impl√©menter avec appel API
  const ordonnances = [
    { id: 'ORD_001', patient: 'Moussa Diop', date: '2023-05-10', medicaments: 'Metformine 500mg' },
    { id: 'ORD_002', patient: 'Aminata Sow', date: '2023-05-12', medicaments: 'Insuline + Metformine' }
  ];
  
  // Mettre √† jour l'interface si n√©cessaire
}

// FONCTIONS DES BOUTONS M√âDECIN
function ouvrirDossier(patientId) {
  alert(`Ouvrir le dossier m√©dical de: ${patientId}`);
  // Redirection vers page d√©tail patient
}

function genererOrdonnance(patientId) {
  // Pr√©-remplir le formulaire d'ordonnance
  const ongletOrdonnances = document.querySelector('#ordonnances-tab');
  if (ongletOrdonnances) {
    ongletOrdonnances.click(); // Basculer vers l'onglet ordonnances
    
    // Pr√©-remplir avec le patient s√©lectionn√©
    setTimeout(() => {
      const selectPatient = document.querySelector('#formOrdonnance select');
      if (selectPatient) {
        selectPatient.value = patientId;
      }
    }, 100);
  }
}

function consulterGlycemie(patient, glycemie) {
  alert(`Consultation glyc√©mie:\nPatient: ${patient}\nValeur: ${glycemie} g/L`);
  // Ouvrir modal d√©taill√©
}

function programmerRdv(patient) {
  const date = prompt(`Programmer RDV pour ${patient}\nDate (JJ/MM/AAAA):`);
  const heure = prompt('Heure (HH:MM):');
  
  if (date && heure) {
    alert(`‚úÖ RDV programm√© pour ${patient}\nüìÖ ${date} √† ${heure}`);
    
    // Envoyer √† l'API
    const donnees = {
      action: 'programmer_rdv',
      patient: patient,
      date: date,
      heure: heure,
      medecin: JSON.parse(localStorage.getItem('user')).nom
    };
    
    // fetch(API_URL, { method: 'POST', body: JSON.stringify(donnees) })
  }
}

function contacterUrgence(patient) {
  const message = `üö® URGENCE M√âDICALE\nPatient: ${patient}\nM√©decin: ${JSON.parse(localStorage.getItem('user')).nom}\nContactez imm√©diatement!`;
  const lienWhatsApp = `https://wa.link/?text=${encodeURIComponent(message)}`;
  window.open(lienWhatsApp, '_blank');
}

// GESTION DU FORMULAIRE D'ORDONNANCE
document.getElementById('formOrdonnance').addEventListener('submit', async function(e) {
  e.preventDefault();
  
  const patientSelect = this.querySelector('select');
  const medicamentsTextarea = this.querySelector('textarea');
  const instructionsTextarea = this.querySelectorAll('textarea')[1];
  const dateControle = this.querySelector('input[type="date"]');
  
  if (!patientSelect.value || !medicamentsTextarea.value) {
    alert('Veuillez remplir le patient et les m√©dicaments');
    return;
  }
  
  const donnees = {
    action: 'ordonnance_medecin',
    id_patient: patientSelect.value,
    nom_patient: patientSelect.options[patientSelect.selectedIndex].text,
    medicaments: medicamentsTextarea.value,
    posologie: instructionsTextarea.value,
    duree: '30 jours',
    medecin: JSON.parse(localStorage.getItem('user')).nom,
    prochain_controle: dateControle.value
  };
  
  try {
    const resultat = await fetch(API_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(donnees)
    });
    
    const reponse = await resultat.json();
    
    if (reponse.status === 'success') {
      alert('‚úÖ Ordonnance g√©n√©r√©e avec succ√®s!');
      this.reset();
      
      // Option: G√©n√©rer PDF ou envoyer par WhatsApp
      if (confirm('Voulez-vous envoyer cette ordonnance par WhatsApp?')) {
        const message = `üìÑ Ordonnance SEN'Diab√®te\nPatient: ${donnees.nom_patient}\nM√©dicaments: ${donnees.medicaments}\nM√©decin: ${donnees.medecin}`;
        const lienWhatsApp = `https://wa.link/?text=${encodeURIComponent(message)}`;
        window.open(lienWhatsApp, '_blank');
      }
    } else {
      alert('‚ùå Erreur: ' + reponse.message);
    }
  } catch (error) {
    alert('‚ùå Erreur de connexion');
  }
});

// BOUTON IMPRIMER
document.getElementById('print-prescription').addEventListener('click', function() {
  alert('üñ®Ô∏è Fonction d\'impression - √Ä impl√©menter');
  // Logique d'impression de l'ordonnance
});

function logout() {
  localStorage.removeItem('user');
  window.location.href = 'index.html';
}

// ACTIVER LES ONGLETS BOOTSTRAP
var triggerTabList = [].slice.call(document.querySelectorAll('#ongletsMedecin button'))
triggerTabList.forEach(function (triggerEl) {
  var tabTrigger = new bootstrap.Tab(triggerEl)
  triggerEl.addEventListener('click', function (event) {
    event.preventDefault()
    tabTrigger.show()
  })
});
    </script>
</body>
</html>
